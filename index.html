<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mess Presence</title>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 40px auto; text-align: center; }
    button { margin: 5px; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; }
    .yes { background: #4CAF50; color: white; }
    .no { background: #F44336; color: white; }
    ul { list-style: none; padding: 0; }
  </style>
</head>
<body>
  <h1>üçΩÔ∏è Mess Presence</h1>
  <input id="name" placeholder="Enter your name" />
  <div>
    <button class="yes" onclick="updateStatus('yes')">Yes</button>
    <button class="no" onclick="updateStatus('no')">No</button>
  </div>
  <h2>Currently at mess:</h2>
  <ul id="list"></ul>

  <script>
    const BIN_ID = "68c12a9643b1c97be93d7249";
    const API_KEY = "$2a$10$M/wsiKvbpvbmYsaPsCM1DulLzZiGAijDt1g2LBxRmnRwo.SiGiLnG";
    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    async function fetchData() {
        const res = await fetch(URL, { headers: { "X-Master-Key": API_KEY } });
        const json = await res.json();
        const data = json.record || {};   // fallback if record is missing
        render(data);
    }

    async function updateStatus(status) {
        const name = document.getElementById("name").value.trim();
        if (!name) return alert("Enter your name first!");

        try {
            // fetch latest
            const res = await fetch(URL, { headers: { "X-Master-Key": API_KEY } });
            const json = await res.json();
            const data = json.record || {};   // <-- fix here

            // update record
            data[name] = status;

            // push update
            const putRes = await fetch(URL, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Master-Key": API_KEY
            },
            body: JSON.stringify(data)
            });

            if (!putRes.ok) {
            const err = await putRes.text();
            console.error("PUT failed:", err);
            alert("Update failed: " + err);
            } else {
            fetchData();
            }
        } catch (err) {
            console.error("Error:", err);
            alert("Something went wrong ‚Äî check console.");
        }
    }


    function render(data) {
      const list = document.getElementById("list");
      list.innerHTML = "";
      Object.entries(data).forEach(([name, status]) => {
        if (status === "yes") {
          const li = document.createElement("li");
          li.textContent = name;
          list.appendChild(li);
        }
      });
    }

    fetchData();
    setInterval(fetchData, 5000); // refresh every 5s
  </script>
</body>
</html>
